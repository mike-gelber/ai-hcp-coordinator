generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Core HCP Profile ───────────────────────────────────────────────

model HcpProfile {
  id        String   @id @default(cuid())
  npi       String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Identity
  firstName   String
  lastName    String
  middleName  String?
  credentials String?
  gender      String?
  photoUrl    String?

  // Demographics
  ageRange String?

  // Professional
  primarySpecialty    String?
  subSpecialty        String?
  boardCertifications String[]
  yearsInPractice     Int?
  medicalSchool       String?
  residency           String?
  enumerationDate     DateTime?

  // Status
  npiStatus         String   @default("pending") // pending, validated, invalid, deactivated
  enrichmentStatus  String   @default("pending") // pending, in_progress, complete, failed
  profileCompleteness Float  @default(0)
  isDemo            Boolean  @default(false)

  // Relations
  locations        HcpLocation[]
  affiliations     HcpAffiliation[]
  publications     HcpPublication[]
  socialProfiles   HcpSocialProfile[]
  prescribingData  HcpPrescribingData[]
  outreachPlans    OutreachPlan[]
  enrichmentLogs   EnrichmentLog[]
  npiUploadItems   NpiUploadItem[]
  clinicalTrials   ClinicalTrial[]
  conversationLogs ConversationLog[]
  proprietaryData  ProprietaryData[]

  @@index([primarySpecialty])
  @@index([npiStatus])
  @@index([enrichmentStatus])
  @@index([isDemo])
  @@index([lastName, firstName])
  @@index([createdAt])
  @@index([updatedAt])
}

// ─── Practice Locations ──────────────────────────────────────────────

model HcpLocation {
  id        String   @id @default(cuid())
  hcpId     String
  hcp       HcpProfile @relation(fields: [hcpId], references: [id], onDelete: Cascade)
  isPrimary Boolean  @default(false)

  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  zipCode      String
  phone        String?
  fax          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hcpId])
  @@index([state])
  @@index([zipCode])
}

// ─── Affiliations ────────────────────────────────────────────────────

model HcpAffiliation {
  id        String   @id @default(cuid())
  hcpId     String
  hcp       HcpProfile @relation(fields: [hcpId], references: [id], onDelete: Cascade)

  organizationName String
  type             String   // hospital, group_practice, academic, other
  role             String?
  isPrimary        Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hcpId])
  @@index([type])
}

// ─── Publications ────────────────────────────────────────────────────

model HcpPublication {
  id        String   @id @default(cuid())
  hcpId     String
  hcp       HcpProfile @relation(fields: [hcpId], references: [id], onDelete: Cascade)

  title         String
  journal       String?
  year          Int?
  pmid          String?   @unique
  coAuthors     String[]
  meshTerms     String[]
  therapeuticArea String?

  createdAt DateTime @default(now())

  @@index([hcpId])
  @@index([year])
}

// ─── Social Profiles ─────────────────────────────────────────────────

model HcpSocialProfile {
  id        String   @id @default(cuid())
  hcpId     String
  hcp       HcpProfile @relation(fields: [hcpId], references: [id], onDelete: Cascade)

  platform    String   // linkedin, twitter, doximity, researchgate, orcid
  profileUrl  String
  username    String?
  followers   Int?
  isActive    Boolean  @default(true)
  isKol       Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([hcpId])
  @@index([platform])
}

// ─── Prescribing Data ────────────────────────────────────────────────

model HcpPrescribingData {
  id        String   @id @default(cuid())
  hcpId     String
  hcp       HcpProfile @relation(fields: [hcpId], references: [id], onDelete: Cascade)

  source          String   // open_payments, medicare_part_d, proprietary
  therapeuticArea String?
  drugName        String?
  claimCount      Int?
  totalCost       Float?
  year            Int?
  paymentAmount   Float?   // For Open Payments
  paymentType     String?  // general, research, ownership

  createdAt DateTime @default(now())

  @@index([hcpId])
  @@index([therapeuticArea])
  @@index([source])
}

// ─── NPI Upload Tracking ─────────────────────────────────────────────

model NpiUpload {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  fileName     String
  source       String   @default("manual") // manual, demo, api
  totalRows    Int
  validNpis    Int
  invalidNpis  Int
  duplicates   Int
  status       String   @default("processing") // processing, complete, failed

  items NpiUploadItem[]
}

model NpiUploadItem {
  id        String   @id @default(cuid())
  uploadId  String
  upload    NpiUpload @relation(fields: [uploadId], references: [id], onDelete: Cascade)
  hcpId     String?
  hcp       HcpProfile? @relation(fields: [hcpId], references: [id])

  npi          String
  status       String   // valid, invalid, duplicate
  errorMessage String?

  createdAt DateTime @default(now())

  @@index([npi])
}

// ─── Outreach ────────────────────────────────────────────────────────

model OutreachPlan {
  id        String   @id @default(cuid())
  hcpId     String
  hcp       HcpProfile @relation(fields: [hcpId], references: [id], onDelete: Cascade)

  persona       Json?    // AI-generated persona document
  strategy      Json?    // AI-generated outreach strategy
  channelMix    String[] // Ordered list of channels
  status        String   @default("draft") // draft, active, paused, completed

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── Enrichment Audit Log ────────────────────────────────────────────

model EnrichmentLog {
  id        String   @id @default(cuid())
  hcpId     String
  hcp       HcpProfile @relation(fields: [hcpId], references: [id], onDelete: Cascade)

  stage      String   // nppes, web_scrape, publications, prescribing, social
  status     String   // started, completed, failed
  source     String?
  dataPoints Int?     // Number of data points added
  error      String?
  duration   Int?     // milliseconds

  createdAt DateTime @default(now())

  @@index([hcpId])
  @@index([stage])
}

// ─── Clinical Trials ─────────────────────────────────────────────────

model ClinicalTrial {
  id        String   @id @default(cuid())
  hcpId     String
  hcp       HcpProfile @relation(fields: [hcpId], references: [id], onDelete: Cascade)

  trialId      String   // ClinicalTrials.gov NCT number
  title        String
  phase        String?
  condition    String?
  intervention String?
  sponsor      String?
  status       String?  // recruiting, completed, etc.
  role         String?  // PI, sub-investigator, etc.

  createdAt DateTime @default(now())

  @@unique([hcpId, trialId])
}

// ─── Conversation Logs ──────────────────────────────────────────────

model ConversationLog {
  id        String   @id @default(cuid())
  hcpId     String
  hcp       HcpProfile @relation(fields: [hcpId], references: [id], onDelete: Cascade)

  channel    String   // email, sms, chat, social
  role       String   // user, assistant, system
  content    String
  metadata   Json?
  tokenCount Int?

  createdAt DateTime @default(now())

  @@index([hcpId, channel])
  @@index([createdAt])
}

// ─── Proprietary Data ───────────────────────────────────────────────

model ProprietaryData {
  id        String   @id @default(cuid())
  hcpId     String
  hcp       HcpProfile @relation(fields: [hcpId], references: [id], onDelete: Cascade)

  source      String   // e.g. "iqvia", "symphony", "internal_crm"
  dataType    String   // e.g. "prescribing", "call_log", "contact_info"
  rawData     Json
  processedAt DateTime?

  createdAt DateTime @default(now())

  @@index([hcpId, source])
}

// ─── NPI Validation Cache ────────────────────────────────────────────

model NpiValidationCache {
  npi         String   @id
  status      String   // validated, invalid, deactivated, organization
  reason      String
  providerData Json?   // Serialized NppesProviderInfo
  validatedAt DateTime
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([expiresAt])
  @@index([status])
}

// ─── App Settings ────────────────────────────────────────────────────

model AppSettings {
  id        String   @id @default("singleton")
  demoMode  Boolean  @default(false)
  updatedAt DateTime @updatedAt
}
